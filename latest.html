<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>LZ2 Artikel Test</title>
</head>
<body>
<h1>Artikeltest</h1>

<!-- Öffentlicher Artikel -->
<article>
  <h2>Öffentlicher Artikel</h2>
  <p>Dieser Artikel ist für alle sichtbar.</p>
</article>

<!-- Geschützter Artikel -->
<article class="lz2" id="lz2-testart"></article>

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://ngtujvgsbymtxphwncuj.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndHVqdmdzYnltdHhwaHduY3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzE4ODAsImV4cCI6MjA3MzM0Nzg4MH0.g9Cmgrua00pJpr6T0uO5FGRIjtgU7TTnGvOw9NHVAr0';
const client = supabase.createClient(supabaseUrl, supabaseKey);

// 💡 Schritt 1: Beim Laden prüfen, ob eine Session existiert
async function checkSession() {
  const { data, error } = await client.auth.getSession();
  console.log('Aktuelle Session:', data, 'Fehler:', error);

  if (error || !data?.session) {
    console.warn('⚠️ Keine gültige Session gefunden – vermutlich abgelaufen oder nie erstellt.');
    document.querySelectorAll('article[class^="lz"]').forEach(a => {
      a.innerHTML = '<p>🚫 Bitte zuerst einloggen.</p>';
    });
    return null;
  }

  return data.session;
}

// 💡 Schritt 2: Reagiere auf Änderungen (Login, Logout, Token-Refresh)
client.auth.onAuthStateChange((event, session) => {
  console.log('🔄 Auth Event:', event);
  if (event === 'TOKEN_REFRESHED') {
    console.log('✅ Token wurde automatisch erneuert.');
  }
  if (event === 'SIGNED_OUT') {
    console.warn('🚫 User wurde ausgeloggt.');
  }
  if (event === 'SIGNED_IN') {
    console.log('✅ User hat sich neu eingeloggt.');
  }
});

// 💡 Schritt 3: Hauptfunktion zum Artikel-Laden
async function loadProtectedArticles() {
  console.log('--- loadProtectedArticles gestartet ---');

  // Session prüfen
  const session = await checkSession();
  if (!session) return;

  const user = session.user;
  console.log('Eingeloggter User:', user);

  // Rechte aus Tabelle users2 laden
  const { data: userData, error: userError } = await client
    .from('users2')
    .select('*')
    .eq('user_id', user.id)
    .maybeSingle();

  console.log('userData aus Tabelle users2:', userData);
  console.log('userError:', userError);

  if (userError || !userData) {
    console.warn('🚫 Kein Profil gefunden.');
    document.querySelectorAll('article[class^="lz"]').forEach(a =>
      a.innerHTML = '<p>🚫 Kein Profil gefunden.</p>'
    );
    return;
  }

  // Artikel laden
  const articles = document.querySelectorAll('article[class^="lz"]');
  for (const article of articles) {
    const articleClass = Array.from(article.classList).find(c => /^lz\d+$/.test(c));
    const articleID = article.id;
    const hasAccess = userData[articleClass];
    console.log('Artikel:', articleID, '→ Zugriff:', hasAccess);

    if (hasAccess === true || hasAccess === 1) {
      try {
        const { data: fileData, error: storageError } = await client.storage
          .from(articleClass)
          .download(`${articleID}.json`);
        if (storageError) throw storageError;

        const text = await fileData.text();
        const json = JSON.parse(text);
        article.innerHTML = `<h2>${json.title}</h2><p>${json.content}</p>`;
        console.log('✅ Artikel geladen:', articleID);
      } catch (err) {
        console.error('Fehler beim Laden des Artikels:', err);
        article.innerHTML = '<p>🚫 Fehler beim Laden des Artikels.</p>';
      }
    } else {
      article.innerHTML = '<p>🚫 Kein Zugriff auf diesen Artikel.</p>';
    }
  }
}

// 💡 Schritt 4: Beim Laden der Seite starten
document.addEventListener('DOMContentLoaded', loadProtectedArticles);
</script>

</body>
</html>
