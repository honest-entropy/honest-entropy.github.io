<!DOCTYPE html>
<html lang="de">
<head>
    <title>Fragezeichen | Auth</title>
    <meta name="author" content="&Eacute;mile Jeremias Ruff">        
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../favicon.ico">

    <link rel="stylesheet" href="../stylesheet.css" type="text/css">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
</head>
<body class="auth">

<div id="terminal"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabaseUrl = 'https://ngtujvgsbymtxphwncuj.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndHVqdmdzYnltdHhwaHduY3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzE4ODAsImV4cCI6MjA3MzM0Nzg4MH0.g9Cmgrua00pJpr6T0uO5FGRIjtgU7TTnGvOw9NHVAr0';
const client = createClient(supabaseUrl, supabaseKey, {
  auth: { persistSession: false }
});

// Session in sessionStorage sichern
client.auth.onAuthStateChange(async (event, session) => {
  if (session) {
    sessionStorage.setItem('sb-session', JSON.stringify(session));
  } else {
    sessionStorage.removeItem('sb-session');
  }
});

// Session beim Laden wiederherstellen
const savedSession = sessionStorage.getItem('sb-session');
if (savedSession) {
  const parsed = JSON.parse(savedSession);
  await client.auth.setSession(parsed);
}

// === Dein restlicher Code ===
const terminal = document.getElementById("terminal");

const lines = [
  "System booting...",
  "Initializing of unnötige protocols",
  "Loading user authentication module",
  "Ready for scheitern.\n"
];

let stage = 0;
let username = "";
let password = "";

function scrollToBottom() {
  terminal.scrollTop = terminal.scrollHeight;
}

function typeLine(text, delay = 50) {
  return new Promise(resolve => {
    let i = 0;
    const interval = setInterval(() => {
      terminal.innerHTML += text.charAt(i);
      scrollToBottom();
      i++;
      if (i >= text.length) {
        clearInterval(interval);
        terminal.innerHTML += "\n";
        scrollToBottom();
        resolve();
      }
    }, delay);
  });
}

async function bootSequence() {
  for (const line of lines) {
    await typeLine(line);
    await new Promise(r => setTimeout(r, 300));
  }
  checkSession();
}

function askUsername() {
  stage = 1;
  terminal.innerHTML += "> Benutzername: ";
  scrollToBottom();
  createInput();
}

function askPassword() {
  stage = 2;
  terminal.innerHTML += "> Passwort: ";
  scrollToBottom();
  createInput(true);
}

function createInput(hidden = false) {
  const input = document.createElement("input");
  input.type = hidden ? "password" : "text";
  terminal.appendChild(input);
  setTimeout(() => input.focus(), 50);
  scrollToBottom();

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      const value = input.value;
      input.remove();
      const displayValue = hidden ? "*".repeat(value.length) : value;
      terminal.innerHTML += displayValue + "\n";
      scrollToBottom();
      if (stage === 1) {
        username = value;
        askPassword();
      } else if (stage === 2) {
        password = value;
        login();
      }
    }
  });
}

async function login() {
  const seq = [
    "\n[Authentifizierung läuft]",
    "Hashe Passwort zu User <" + username + ">..."
  ];
  for (const line of seq) {
    await typeLine(line);
    await new Promise(r => setTimeout(r, 400));
  }

  const { data, error } = await client.auth.signInWithPassword({
    email: username + "@example.com",
    password: password
  });

  if (error) {
    await typeLine("Fehler: Zugriff verweigert.");
    await typeLine("Grund: " + error.message);
    await typeLine("\nBitte versuche es erneut.\n");
    askUsername();
    return;
  }

  await typeLine("Zugriff gewährt.\n");
  await typeLine("Willkommen, " + username + "!");
  askReturn();
}

async function askReturn() {
  await typeLine("\n> System bereit.\n> Zurück zur letzten Seite kehren? [Y/N]");
  document.addEventListener("keydown", handleReturnDecision);
  scrollToBottom();
}

async function handleReturnDecision(e) {
  const key = e.key.toLowerCase();
  if (key === "y" || key === "n") {
    document.removeEventListener("keydown", handleReturnDecision);
    terminal.innerHTML += key.toUpperCase() + "\n";
    scrollToBottom();
    if (key === "y") {
      await typeLine("\nStarte Redirect...");
      authRedirect();
    } else {
      askLogout();
    }
  }
}

async function askLogout() {
  await typeLine("\n> Möchtest du dich ausloggen? [Y/N]");
  document.addEventListener("keydown", handleLogoutDecision);
  scrollToBottom();
}

async function handleLogoutDecision(e) {
  const key = e.key.toLowerCase();
  if (key === "y" || key === "n") {
    document.removeEventListener("keydown", handleLogoutDecision);
    terminal.innerHTML += key.toUpperCase() + "\n";
    scrollToBottom();
    if (key === "y") {
      await logout();
    } else {
      await typeLine("\nOkay, Session bleibt aktiv. (Kehre zurück zu dieser Seite, wenn du dich ausloggen möchtest)");
    }
  }
}

async function logout() {
  await typeLine("\nBeende Session...");
  const { error } = await client.auth.signOut();
  if (error) {
    await typeLine("Fehler beim Ausloggen: " + error.message);
  } else {
    await typeLine("Erfolgreich ausgeloggt.");
  }
  await typeLine("[Neustart des Systems]");
  await new Promise(r => setTimeout(r, 1000));
  terminal.innerHTML = "";
  scrollToBottom();
  bootSequence();
}

async function checkSession() {
  const { data } = await client.auth.getSession();
  const session = data.session;
  if (session && session.user) {
    username = session.user.email;
    await typeLine("Willkommen zurück, " + username + "!");
    askLogout();
  } else {
    askUsername();
  }
}

function authRedirect() {
  const params = new URLSearchParams(window.location.search);
  const redirectUrl = params.get('redirect');
  const referrer = document.referrer;
  const target = redirectUrl || referrer;
  if (!target) {
    terminal.innerHTML += "\nFehler: Kein Ziel gefunden.";
    scrollToBottom();
    askLogout();
    return;
  }
  window.location.href = target;
}

bootSequence();
</script>


</body>
</html>
